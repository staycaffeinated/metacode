# The MetaCode Code Generator

This utility generates boilerplate code with simple
command line arguments. The utility currently supports:

* RESTful web services based on Spring

This project is a re-envisioning of the Mojo code generator.

## Features

A project generated by Mojo has these features:

* Uses Spring framework
* Uses Gradle build files
* Generates unit and integration tests that provide 90% code coverage
* Support for: Postgres, H2, Liquibase, TestContainers
* Generates a docker-compose.yaml file to launch the micro-service and database
* Support for SonarQube to enable code coverage analysis
* Generates a README file with instructions on how to build and maintain the generated code
* Secure, random resource IDs with 160-bit entropy

## Installation

A Homebrew Tap exists for this code.  To install with homebrew, do this:

```[bash]
   $ brew tap staycaffeinated/tap/metacode
   $ brew install metacode
```
To verify the success of the installation, run:

```[bash]
   $ metacode --version
```

## MetaCode Command Line Usage:

First, it is important to know the project assets will be created in your current
directory, so be sure to navigate to the folder in which
you want the project assets created before running any command.

POSIX-style syntax is supported, allowing options to be specified as
```-option value``` or as ```-option=value```.

The command
```[bash]
    $ metacode create project --help
```

shows the different options for creating a project. The simplest way to
create a project is to specify a name, base package, and base path, such as:
    
```[bash]
    $ metacode create project spring-webmvc --name petstore --package org.acme.petstore --base-path /petstore
```

which creates the project assets in the current directory,
with the default Java package name of ```org.acme.petstore``` and
a base URL of ```http://localhost:8080/petstore```

A base project will have a root controller that returns an HTTP 200 without a response body.
To add additional endpoints, use the ```create endpoint``` command:
For example,

```[bash]
    $ metacode create endpoint --resource Pet --route /pet
    $ metacode create endpoint --resource Store --route /store
```

## Build and run a project

Let's walk through two examples, using Spring's venerable petstore example 
as the starting point.  We'll implement two resources, Pet and Store. 

### Building the Spring WebMvc Version

Step 1: Create a new directory; we'll start with a Spring WebMvc project:

```[bash]
   $ mkdir petstore-webmvc
   $ cd petstore-webmvc
```

Step 2: Create the project-level assets:

```[bash]
   $ metacode create project spring-webmvc --name petstore --package org.acme.petstore --base-path /petstore
```

Step 3: Create the Gradle wrapper

```[bash]
   $ gradle wrapper
```

Step 4: Compile the code

```[bash]
   $ ./gradlew build
```

Step 5: Add an endpoint for Pets

```[bash]
   $ metacode create endpoint --resource Pet --route /pet
```

Step 6: Add an endpoint for Stores

```[bash]
   $ metacode create endpoint --resource Store --route /store
```

Step 7: Compile the new code

```[bash]
   $ ./gradlew build
```

Step 8: Run the application

```[bash]
   $ ./gradlew bootRun
```

Step 9: Try it out in a browser

Try these URLs to see how the generated code behaves:
   
```http request
http://localhost:8080/petstore
http://localhost:8080/petstore/pet/
http://localhost:8080/petstore/pet/findAll
http://localhost:8080/petstore/store/
http://localhost:8080/petstore/store/findAll
```

### Building the Spring WebFlux Version

Step 1: Create a new directory for the project:

```[bash]
   $ mkdir petstore-webflux
   $ cd petstore-webflux
```

Step 2: Create the project-level assets:

```[bash]
   $ metacode create project spring-webflux --name petstore --package org.acme.petstore --base-path /petstore
```

Step 3: Create the Gradle wrapper

```[bash]
   $ gradle wrapper
```

Step 4: Compile the code

```[bash]
   $ ./gradlew build
```

Step 5: Add an endpoint for Pets

```[bash]
   $ metacode create endpoint --resource Pet --route /pet
```

Step 6: Add an endpoint for Store

```[bash]
   $ metacode create endpoint --resource Store --route /store
```

Step 7: Compile the new code

```[bash]
   $ ./gradlew build
```

Step 8: Run the application

```[bash]
   $ ./gradlew bootRun
```

Step 9: Try it out in a browser

Try these URLs to see how the generated code behaves:

```http request

http://localhost:8080/petstore
http://localhost:8080/petstore/pet/
http://localhost:8080/petstore/pet/findAll
http://localhost:8080/petstore/store/
http://localhost:8080/petstore/store/findAll

```
          
## Other Features

### Build a Docker image for the application

The Gradle build uses JIB as the tool to build
the Docker image.  JIB allows the base image
to be specified, which enables the developer to
specify a hardened base image instead of an
off-the-shelf image. 

To build the Docker image, run:

```[bash]
   $ ./gradlew bootBuildImage
```
   
### Check the health of the running application

To check the health of the microservice, the following URL works
with both Spring WebMvc and Spring WebFlux projects.

```[http request]
   http://localhost:8080/petstore/_internal/health
```

### Get a code coverage report

The build scripts use Jacoco and Sonarqube
to generate code coverage reports. Of course,
to use Sonarqube, you have to have Sonarqube
running.  A local instance of Sonarqube can be
started via Docker by following these instructions:

```http request
https://hub.docker.com/r/bitnami/sonarqube
```
The credentials to that instance of Sonarqube
are contained in the docker-compose.yml file.
The credentials do get rotated by Bitnami, so
expect them to change at least every month.

In the project's root directory, edit the
gradle.properties file and update the
Sonarqube credentials, along with any of
the other settings. Then run:

```[bash]
   $ ./gradlew build integrationTest jacocoTestReport sonarqube
```

When it finished, log into the Sonarqube
console to see the results (e.g., localhost:[PORT],
where the [PORT] number can be found in Bitnami's
docker-compose.yml file). 


